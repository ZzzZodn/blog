### 组策略

管理员通过组策略管理企业中的计算机，当计算机或者用户应用组策略后，大部分更改结果保存在当前计算机的注册表中，客户端计算机或者域控制器通过读取注册 表中的设置完成管理任务。组策略分为2种类型，即本地组策略和域组策略。

-   域组策略基于森林、站点、域、组织单位的组策略都属于非本地组策略。存储在域控制器中，非本地组策略对象只能在Acitive Directory环境下使用。适用于组策略对象所关联的站点、域或组织单位中的用户和计算机。

-   本地组策略。本地组策略是只能在本机上使用的策略，对其他域用户（用户账户和计算机账户）无效。在工作组或单机环境下，本地组策略仅能管理当前环境下正在使用的计算机。如果当前的计算机已经加入域，但是没有登录到域中，本地组策略有效。

域组策略又分为用户策略和计算机策略，分别针对域用户和客户端计算机。应用了用户策略的用户，无论在域内哪台计算机上登录，都会应用响应的策略。同理，计算机策略也一样。域控制器默认每五分钟刷新策略设置，域成员默认90-120分钟刷新。

#### 组策略对象(GPO)

组策略对象，GPO（Group Policy Object），实际上就是组策略设置的集合，包含用于特定用户和计算机的策略信息和配置。每个GPO在本地计算机有唯一的对应GUID用于标志。在域中，有两个默认的组策略对象**Default Domain Policy**和**Domain Controllers**，其对应的GUID分别为｛31B2F340-016D-11D2-945F-00C04FB984F9｝、{6AC1786C-016F-11D2-945F- 00C04FB984F9｝。

组策略对象的内容分为两部分：组策略容器（Gourp Policy Container，简称GPC）和组策略模板（Group Policy Template，简称GPT)。 GPC内容存储在Acitve Directory数据库中，记录组策略对象的属性和版本等信息。GPT 存储组策略对象的设置值和相关文件，是一个文件夹，默认位置“%systemroot%\sysvol\sysvol\域名\Policy

![](/Users/cate4cafe/工作/文章/组策略/media/1.jpg)

#### 组策略和注册表

大部分组策略的更改结果保存在当前计算机的注册表中，客户端计算机或者域控制器通过读取注册 表中的设置完成管理任务。以更改域内windows更新策略为例

![](/Users/cate4cafe/工作/文章/组策略/media/2.jpg)

通过ProcessMonitor监视注册表的修改动作，在组策略设置更新服务器时，可以定位到修改的相应注册表键值。在实际环境中，我们在有权限的情况下，可以使用远程注册表管理功能直接修改注册表来达到修改组策略的效果。

#### 组策略关闭防火墙

实际环境中，目标机器开启防火墙，会导致常规的如psexec、wmic等方式无法横向到目标机器。这时，可通过组策略配置，关闭目标防火墙，或者根据实际情况配置

![](/Users/cate4cafe/工作/文章/组策略/media/3.jpg)

#### 配置IE代理

给相应的组配置组策略下发IE代理服务器，在组中的成员应用了组策略之后，使用IE代理设置的网络流量会使用指定的代理。如果我们在内网中使用burp,并把代理服务器设置为burp的代理ip和端口，便可以看见目标浏览信息。

![](/Users/cate4cafe/工作/文章/组策略/media/4.jpg)

由于默认组策略刷新时间间隔过长，实战中可先设置组策略刷新间隔时间，再通过

```
Import-Module GroupPolicy -verbose;
Invoke-GPUpdate -RandomDelayInMinutes 0 -Computer webserver
```

命令强制某台机器刷新组策略。注：目标机器会cmd框提醒正在刷新组策略。另外，组策略应用的最小对象为组，如要针对某个用户，可以新建一个组，把该用户加入到组里面，再配置组策略应用到该组即可

```
New-ADOrganizationalUnit -Name IT -Path "DC=cate4cafe,DC=com"
move-adobject –identity  "CN=2008r2,CN=Users,DC=cate4cafe,DC=com"  -targetpath "ou=IT,dc=cat
e4cafe,dc=com"
```

#### 其他

使用组策略还可下发MSI安装包、配置计划任务、设置域登录脚本等不赘述了。

附：[组策略操作cmdlet](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ee461025(v=technet.10))